<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BabyLog</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/timezone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/duration.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/ja.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-dayjs@1.0.0"></script>
    <style>
        [v-cloak] { display: none; }
        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.3s ease;
        }
        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }
    </style>
</head>

<body class="bg-slate-100 text-slate-800">
{% raw %}
    <div id="app" v-cloak class="container mx-auto max-w-6xl p-4 sm:p-6">

        <!-- Header -->
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-4xl font-bold text-slate-900">BabyLog</h1>
            <button @click="toggleView" class="p-2 rounded-full hover:bg-slate-200 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                </svg>
            </button>
        </header>

        <transition name="fade" mode="out-in">
            <!-- Main View -->
            <main v-if="currentView === 'main'" key="main">
                <!-- Action Buttons -->
                <div class="grid grid-cols-4 gap-3 sm:gap-4 mb-6">
                    <button @click="logBreastfeeding" :class="breastfeedingClass" class="aspect-square rounded-2xl shadow-sm flex flex-col items-center justify-center transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" viewBox="0 0 20 20" fill="currentColor"><path d="M5.5 2.5a2.5 2.5 0 100 5 2.5 2.5 0 000-5zM15.5 2.5a2.5 2.5 0 100 5 2.5 2.5 0 000-5zM5 15a5 5 0 0010 0v-1a5 5 0 00-10 0v1z" /></svg>
                        <span v-if="breastfeedingTimer.isActive" class="text-sm font-mono mt-1">{{ breastfeedingTimer.elapsed }}</span>
                    </button>
                    <button @click="logEvent('milk')" class="bg-white hover:bg-slate-200 aspect-square rounded-2xl shadow-sm flex items-center justify-center transition-colors text-slate-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </button>
                    <button @click="logEvent('pee_poop')" class="bg-white hover:bg-slate-200 aspect-square rounded-2xl shadow-sm flex items-center justify-center transition-colors text-slate-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                    </button>
                    <button @click="logEvent('pee')" class="bg-white hover:bg-slate-200 aspect-square rounded-2xl shadow-sm flex items-center justify-center transition-colors text-slate-600">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                    </button>
                </div>

                <!-- Two-Column Log Layout -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <section>
                        <h2 class="text-lg font-semibold mb-3 text-slate-800">Êéà‰π≥„É≠„Ç∞</h2>
                        <div class="p-4 rounded-xl text-center mb-4 bg-blue-100 text-blue-800">
                            <p class="font-semibold text-base">{{ prediction.milk.message }}</p>
                            <p v-if="prediction.milk.next_time" class="text-sm mt-1">
                                {{ formatTime(prediction.milk.next_time) }} È†É ({{ fromNow(prediction.milk.next_time) }})
                            </p>
                            <p class="text-xs text-slate-500 mt-2 pt-2 border-t border-blue-200">{{ prediction.milk.plan_message }}</p>
                        </div>
                        <ul class="space-y-2">
                            <li v-if="milkEvents.length === 0" class="text-center text-slate-500 pt-8 text-sm">Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</li>
                            <li v-for="event in milkEvents" :key="event.id" class="bg-white p-3 rounded-xl shadow-sm flex items-center justify-between">
                                <div class="flex items-center font-semibold">
                                    <div class="text-xl mr-3">{{ event.event_type === 'milk' ? 'üçº' : 'ü§±' }}</div>
                                    <div v-if="event.amount">{{ event.amount }}{{ event.event_type === 'breastfeeding' ? 'ÂàÜ' : 'ml' }}</div>
                                </div>
                                <div class="flex items-center">
                                    <p class="font-bold text-base mr-3">{{ formatDateTime(event.timestamp) }}</p>
                                    <button @click="deleteEvent(event.id)" class="p-2 rounded-full hover:bg-slate-200 transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                    </button>
                                </div>
                            </li>
                        </ul>
                    </section>

                    <section>
                        <h2 class="text-lg font-semibold mb-3 text-slate-800">„Åä„ÇÄ„Å§„É≠„Ç∞</h2>
                        <div class="p-4 rounded-xl text-center mb-4 bg-teal-100 text-teal-800">
                             <p class="font-semibold text-base">{{ prediction.diaper.message }}</p>
                            <p v-if="prediction.diaper.next_time" class="text-sm mt-1">
                                {{ formatTime(prediction.diaper.next_time) }} È†É ({{ fromNow(prediction.diaper.next_time) }})
                            </p>
                            <p class="text-xs text-slate-500 mt-2 pt-2 border-t border-teal-200">{{ prediction.diaper.plan_message }}</p>
                        </div>
                        <ul class="space-y-2">
                            <li v-if="diaperEvents.length === 0" class="text-center text-slate-500 pt-8 text-sm">Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</li>
                             <li v-for="event in diaperEvents" :key="event.id" class="bg-white p-3 rounded-xl shadow-sm flex items-center justify-between">
                                <div class="flex items-center font-semibold">
                                    <div class="text-xl mr-3">
                                        <span v-if="event.is_pee && event.is_poop">üíßüí©</span>
                                        <span v-else-if="event.is_pee">üíß</span>
                                        <span v-else-if="event.is_poop">üí©</span>
                                    </div>
                                </div>
                                 <div class="flex items-center">
                                    <p class="font-bold text-base mr-3">{{ formatDateTime(event.timestamp) }}</p>
                                    <button @click="deleteEvent(event.id)" class="p-2 rounded-full hover:bg-slate-200 transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                    </button>
                                </div>
                            </li>
                        </ul>
                    </section>
                </div>
            </main>
            
            <!-- Dashboard View -->
            <main v-else key="dashboard">
                <h2 class="text-2xl font-bold mb-4">„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„Çø„Ç§„É†„É©„Ç§„É≥</h2>
                <div class="bg-white p-2 sm:p-4 rounded-2xl shadow-sm">
                    <canvas id="eventsChart"></canvas>
                </div>
            </main>
        </transition>

    </div>
{% endraw %}
<script>
    dayjs.extend(dayjs_plugin_utc);
    dayjs.extend(dayjs_plugin_timezone);
    dayjs.extend(dayjs_plugin_relativeTime);
    dayjs.extend(dayjs_plugin_duration);
    dayjs.locale('ja');
    dayjs.tz.setDefault("Asia/Tokyo");

    const { createApp } = Vue;

    createApp({
        data() {
            return {
                prediction: {
                    milk: { message: 'Ë™≠„ÅøËæº„Åø‰∏≠...', plan_message: '...' },
                    diaper: { message: 'Ë™≠„ÅøËæº„Åø‰∏≠...', plan_message: '...' }
                },
                allEvents: [],
                lastMilkAmount: 120,
                currentView: 'main',
                chart: null,
                breastfeedingTimer: { isActive: false, startTime: null, intervalId: null, elapsed: '00:00' },
            }
        },
        watch: {
            currentView(newView, oldView) {
                if (newView === 'dashboard') {
                    this.$nextTick(() => {
                        this.renderChart();
                    });
                }
            }
        },
        computed: {
            milkEvents() {
                return this.allEvents.filter(e => e.event_type === 'milk' || e.event_type === 'breastfeeding').slice(0, 10);
            },
            diaperEvents() {
                return this.allEvents.filter(e => e.event_type === 'diaper').slice(0, 10);
            },
            breastfeedingClass() {
                return this.breastfeedingTimer.isActive 
                    ? 'bg-blue-500 text-white' 
                    : 'bg-white hover:bg-slate-200 text-slate-600';
            }
        },
        methods: {
            toggleView() {
                this.currentView = this.currentView === 'main' ? 'dashboard' : 'main';
            },
            formatTime(iso) { return iso ? dayjs.utc(iso).tz().format('HH:mm') : ''; },
            formatDateTime(iso) { return iso ? dayjs.utc(iso).tz().format('M/D HH:mm') : ''; },
            fromNow(iso) { return iso ? dayjs.utc(iso).tz().fromNow() : ''; },
            
            async apiCall(url, method = 'GET', body = null) {
                const options = { method, headers: { 'Content-Type': 'application/json' } };
                if (body) options.body = JSON.stringify(body);
                const response = await fetch(url, options);
                if (!response.ok) {
                    if (response.status === 401) window.location.href = '/login';
                    throw new Error(`API Error: ${response.status}`);
                }
                return response.status === 204 ? null : response.json();
            },
            async fetchPrediction() { 
                this.prediction = await this.apiCall('/api/prediction');
            },
            async fetchAllEvents() {
                this.allEvents = await this.apiCall('/api/events?limit=500') || [];
                const lastMilk = this.allEvents.find(e => e.event_type === 'milk');
                if (lastMilk) this.lastMilkAmount = lastMilk.amount;
            },
            async refreshData() {
                try {
                    await Promise.all([this.fetchPrediction(), this.fetchAllEvents()]);
                    if (this.currentView === 'dashboard') {
                       this.$nextTick(() => this.renderChart());
                    }
                } catch (error) {
                    console.error("Data refresh failed:", error);
                }
            },
            async logEvent(type) {
                let eventData = {};
                switch (type) {
                    case 'milk': eventData = { event_type: 'milk', amount: this.lastMilkAmount }; break;
                    case 'pee': eventData = { event_type: 'diaper', is_pee: true, is_poop: false }; break;
                    case 'poop': eventData = { event_type: 'diaper', is_pee: false, is_poop: true }; break;
                    case 'pee_poop': eventData = { event_type: 'diaper', is_pee: true, is_poop: true }; break;
                }
                await this.apiCall('/api/events', 'POST', eventData);
                this.refreshData();
            },
            async logBreastfeeding() {
                if (!this.breastfeedingTimer.isActive) {
                    this.breastfeedingTimer.isActive = true;
                    this.breastfeedingTimer.startTime = dayjs();
                    localStorage.setItem('breastfeedingStartTime', this.breastfeedingTimer.startTime.toISOString());
                    this.breastfeedingTimer.intervalId = setInterval(() => {
                        const diff = dayjs().diff(this.breastfeedingTimer.startTime);
                        this.breastfeedingTimer.elapsed = dayjs.duration(diff).format('mm:ss');
                    }, 1000);
                } else {
                    clearInterval(this.breastfeedingTimer.intervalId);
                    const durationMinutes = Math.round(dayjs().diff(this.breastfeedingTimer.startTime, 'minute', true));
                    const eventData = {
                        event_type: 'breastfeeding', amount: durationMinutes || 1,
                        timestamp: this.breastfeedingTimer.startTime.utc().toISOString(),
                    };
                    await this.apiCall('/api/events', 'POST', eventData);
                    this.breastfeedingTimer.isActive = false;
                    localStorage.removeItem('breastfeedingStartTime');
                    this.refreshData();
                }
            },
            async deleteEvent(id) {
                if (confirm('„Åì„ÅÆË®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                    await this.apiCall(`/api/events/${id}`, 'DELETE');
                    this.refreshData();
                }
            },
            renderChart() {
                const ctx = document.getElementById('eventsChart')?.getContext('2d');
                if (!ctx) return;

                const twoWeeksAgo = dayjs().subtract(14, 'day').startOf('day');
                const chartData = this.allEvents.filter(e => dayjs(e.timestamp).isAfter(twoWeeksAgo));

                const milkData = chartData
                    .filter(e => e.event_type === 'milk' || e.event_type === 'breastfeeding')
                    .map(e => ({ x: e.timestamp, y: dayjs.utc(e.timestamp).tz().hour() + dayjs.utc(e.timestamp).tz().minute() / 60 }));
                
                const diaperData = chartData
                    .filter(e => e.event_type === 'diaper')
                    .map(e => ({ x: e.timestamp, y: dayjs.utc(e.timestamp).tz().hour() + dayjs.utc(e.timestamp).tz().minute() / 60 }));

                if (this.chart) this.chart.destroy();
                this.chart = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'Êéà‰π≥', data: milkData,
                            backgroundColor: 'rgba(59, 130, 246, 0.7)',
                            pointStyle: 'circle', radius: 6,
                        }, {
                            label: '„Åä„ÇÄ„Å§', data: diaperData,
                            backgroundColor: 'rgba(20, 184, 166, 0.7)',
                            pointStyle: 'rect', radius: 6,
                        }]
                    },
                    options: {
                        scales: {
                            x: {
                                type: 'time',
                                time: { unit: 'day', displayFormats: { day: 'M/D' } },
                                min: twoWeeksAgo.toISOString(),
                                max: dayjs().endOf('day').toISOString(),
                            },
                            y: {
                                reverse: true, min: 0, max: 24,
                                ticks: { stepSize: 3, callback: value => `${value}:00` }
                            }
                        },
                        plugins: { tooltip: { callbacks: {
                            label: (context) => {
                                const y = context.parsed.y;
                                const hour = Math.floor(y);
                                const minute = Math.round((y - hour) * 60);
                                return `${context.dataset.label} @ ${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                            }
                        }}}
                    }
                });
            },
            checkRunningBreastfeedingTimer() {
                const savedStartTime = localStorage.getItem('breastfeedingStartTime');
                if (savedStartTime) {
                    this.breastfeedingTimer.startTime = dayjs(savedStartTime);
                    this.breastfeedingTimer.isActive = true;
                     this.breastfeedingTimer.intervalId = setInterval(() => {
                        const diff = dayjs().diff(this.breastfeedingTimer.startTime);
                        this.breastfeedingTimer.elapsed = dayjs.duration(diff).format('mm:ss');
                    }, 1000);
                }
            }
        },
        mounted() {
            this.refreshData();
            this.checkRunningBreastfeedingTimer();
            setInterval(this.refreshData, 60000);
        }
    }).mount('#app');
</script>
</body>
</html>